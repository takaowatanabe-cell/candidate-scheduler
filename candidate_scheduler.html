<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>候補日時メーカー</title>
  <style>
    :root { --bg:#0b0f17; --card:#121a27; --muted:#93a4bf; --fg:#e7eefc; --line:#22314a; --accent:#4ea1ff; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { max-width:1100px; margin:24px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns: 420px 1fr; gap:16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h1 { font-size:18px; margin:0 0 12px; }
    h2 { font-size:14px; margin:0 0 10px; color:var(--muted); font-weight:600; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { border:1px solid var(--line); background:#0f1624; color:var(--fg); padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px; }
    .btn:hover { border-color:#2f4466; }
    .btn.primary { background: linear-gradient(180deg, rgba(78,161,255,.22), rgba(78,161,255,.08)); border-color: rgba(78,161,255,.4); }
    .btn.danger { background: rgba(255,80,80,.08); border-color: rgba(255,80,80,.35); }
    .btn.small { padding:6px 8px; border-radius:9px; font-size:12px; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#0f1624; color:var(--fg); font-size:12px; }
    .pill b { font-weight:700; }
    .muted { color:var(--muted); }
    textarea { width:100%; height:360px; resize:vertical; border-radius:12px; padding:12px; border:1px solid var(--line); background:#0f1624; color:var(--fg); font-size:13px; line-height:1.55; }
    .two { display:grid; grid-template-columns: 1fr; gap:12px; }
    .cal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .cal-title { font-weight:700; letter-spacing:.2px; }
    .cal { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .dow { text-align:center; font-size:12px; color:var(--muted); padding:6px 0; }
    .day {
      border:1px solid var(--line);
      background:#0f1624;
      border-radius:10px;
      padding:10px 8px;
      min-height:44px;
      cursor:pointer;
      position:relative;
      user-select:none;
    }
    .day:hover { border-color:#2f4466; }
    .day.off { opacity:.35; cursor:default; }
    .day.selected { border-color: rgba(78,161,255,.7); box-shadow: 0 0 0 2px rgba(78,161,255,.15) inset; }
    .day .n { font-weight:700; font-size:13px; }
    .day .mark { position:absolute; right:8px; top:8px; font-size:10px; color: var(--accent); }
    .panel { border:1px dashed #2a3b5a; border-radius:12px; padding:12px; background:rgba(255,255,255,.02); }
    .time-grid { display:grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap:6px; margin-top:10px; }
    .chip {
      border:1px solid var(--line);
      background:#0f1624;
      border-radius:10px;
      padding:8px 6px;
      text-align:center;
      cursor:pointer;
      font-size:12px;
    }
    .chip:hover { border-color:#2f4466; }
    .chip.on { border-color: rgba(78,161,255,.7); background: rgba(78,161,255,.10); }
    .chip.disabled { opacity:.35; cursor:default; }
    .hint { font-size:12px; color:var(--muted); margin-top:8px; }
    .toast { margin-left:auto; font-size:12px; color: var(--muted); }
    .kbd { border:1px solid var(--line); padding:2px 6px; border-radius:6px; font-size:11px; background:#0f1624; color:var(--fg); }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } textarea{ height: 300px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>候補日時メーカー（9:00〜19:00 / 30分刻み・午前/午後/終日対応）</h1>

    <div class="grid">
      <!-- Left: Calendar -->
      <div class="card">
        <div class="cal-head">
          <div class="row">
            <button class="btn small" id="prevBtn">←</button>
            <div class="cal-title" id="monthTitle"></div>
            <button class="btn small" id="nextBtn">→</button>
          </div>
          <div class="toast" id="toast"></div>
        </div>

        <div class="cal" id="dowRow"></div>
        <div class="cal" id="calGrid"></div>

        <div class="hint">
          ・日付クリックで選択/解除（複数可）<br/>
          ・右側で「終日/午前/午後/個別時間」を設定<br/>
          ・時間は 9:00〜19:00 の30分刻み
        </div>
      </div>

      <!-- Right: Editor -->
      <div class="card two">
        <div>
          <h2>選択中の日付</h2>
          <div class="row" id="selectedPills"></div>
        </div>

        <div class="panel">
          <h2 id="activeDateTitle">日付を選択してください</h2>
          <div class="row">
            <button class="btn" id="modeAllDay">終日</button>
            <button class="btn" id="modeAM">午前</button>
            <button class="btn" id="modePM">午後</button>
            <span class="muted">or</span>
            <button class="btn" id="modeTimes">時間を選ぶ</button>
            <button class="btn danger" id="clearActive" title="この日付の選択内容をクリア">この日の内容をクリア</button>
          </div>

          <div class="time-grid" id="timeGrid"></div>
          <div class="hint">※「終日/午前/午後」を選ぶと、個別時間は無効になります。</div>
        </div>

        <div>
          <h2>出力（固定文言 + 候補日時一覧）</h2>
          <div class="row" style="margin-bottom:10px;">
            <button class="btn primary" id="copyBtn">コピー</button>
            <button class="btn" id="resetBtn">全リセット</button>
            <span class="toast" id="copyToast"></span>
            <span class="muted">（コピーは <span class="kbd">Ctrl</span> + <span class="kbd">C</span> 不要）</span>
          </div>
          <textarea id="output" spellcheck="false"></textarea>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Utilities =====
  const pad2 = (n) => String(n).padStart(2, "0");
  const wday = ["日","月","火","水","木","金","土"];
  const ymdKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  function formatJPDateWithWday(d){
    // 2026年1月21日（水）
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    const day = d.getDate();
    const wd = wday[d.getDay()];
    return `${y}年${m}月${day}日（${wd}）`;
  }

  function timeLabel(minutesFromMidnight){
    const h = Math.floor(minutesFromMidnight/60);
    const m = minutesFromMidnight%60;
    return `${h}:${pad2(m)}`; // halfwidth
  }

  function sortKeys(keys){
    return [...keys].sort((a,b)=> (a < b ? -1 : a > b ? 1 : 0));
  }

  // ===== State =====
  // selections[key] = { mode: "times" | "allday" | "am" | "pm", times: Set<number> }
  const selections = new Map();
  let view = new Date(); // month view
  view.setDate(1);
  let activeKey = null;

  // ===== DOM =====
  const monthTitle = document.getElementById("monthTitle");
  const calGrid = document.getElementById("calGrid");
  const dowRow = document.getElementById("dowRow");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const selectedPills = document.getElementById("selectedPills");
  const activeDateTitle = document.getElementById("activeDateTitle");
  const timeGrid = document.getElementById("timeGrid");
  const output = document.getElementById("output");
  const toast = document.getElementById("toast");
  const copyToast = document.getElementById("copyToast");

  const modeAllDay = document.getElementById("modeAllDay");
  const modeAM = document.getElementById("modeAM");
  const modePM = document.getElementById("modePM");
  const modeTimes = document.getElementById("modeTimes");
  const clearActive = document.getElementById("clearActive");
  const copyBtn = document.getElementById("copyBtn");
  const resetBtn = document.getElementById("resetBtn");

  // ===== Build DOW header =====
  function renderDow(){
    dowRow.innerHTML = "";
    for(const d of wday){
      const el = document.createElement("div");
      el.className = "dow";
      el.textContent = d;
      dowRow.appendChild(el);
    }
  }

  // ===== Calendar =====
  function renderCalendar(){
    monthTitle.textContent = `${view.getFullYear()}年 ${view.getMonth()+1}月`;
    calGrid.innerHTML = "";

    const firstDay = new Date(view.getFullYear(), view.getMonth(), 1);
    const startDow = firstDay.getDay();
    const daysInMonth = new Date(view.getFullYear(), view.getMonth()+1, 0).getDate();

    // Fill leading blanks (previous month days shown as off)
    for(let i=0;i<startDow;i++){
      const blank = document.createElement("div");
      blank.className = "day off";
      blank.innerHTML = `<div class="n"></div>`;
      calGrid.appendChild(blank);
    }

    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(view.getFullYear(), view.getMonth(), day);
      const key = ymdKey(d);

      const cell = document.createElement("div");
      cell.className = "day";
      if(selections.has(key)) cell.classList.add("selected");
      if(activeKey === key) cell.style.outline = "2px solid rgba(78,161,255,.55)";

      const mark = selections.has(key) ? `<div class="mark">●</div>` : "";
      cell.innerHTML = `<div class="n">${day}</div>${mark}`;

      cell.addEventListener("click", () => {
        // toggle select
        if(selections.has(key)){
          selections.delete(key);
          if(activeKey === key) activeKey = null;
        } else {
          selections.set(key, { mode:"times", times:new Set() });
          activeKey = key;
        }
        flash(`選択: ${selections.size}日`);
        renderAll();
      });

      calGrid.appendChild(cell);
    }

    // trailing blanks to keep grid nice (optional)
    const totalCells = startDow + daysInMonth;
    const tail = (7 - (totalCells % 7)) % 7;
    for(let i=0;i<tail;i++){
      const blank = document.createElement("div");
      blank.className = "day off";
      blank.innerHTML = `<div class="n"></div>`;
      calGrid.appendChild(blank);
    }
  }

  prevBtn.addEventListener("click", () => {
    view = new Date(view.getFullYear(), view.getMonth()-1, 1);
    renderAll();
  });
  nextBtn.addEventListener("click", () => {
    view = new Date(view.getFullYear(), view.getMonth()+1, 1);
    renderAll();
  });

  // ===== Pills / active date =====
  function renderPills(){
    selectedPills.innerHTML = "";
    const keys = sortKeys([...selections.keys()]);
    if(keys.length === 0){
      const span = document.createElement("span");
      span.className = "muted";
      span.textContent = "未選択";
      selectedPills.appendChild(span);
      activeDateTitle.textContent = "日付を選択してください";
      return;
    }

    keys.forEach((key) => {
      const d = new Date(key + "T00:00:00");
      const pill = document.createElement("span");
      pill.className = "pill";
      const isActive = (key === activeKey);
      pill.innerHTML = `<b>${formatJPDateWithWday(d)}</b> ${isActive ? "（編集中）" : ""}`;
      pill.style.cursor = "pointer";
      pill.addEventListener("click", () => {
        activeKey = key;
        renderAll();
      });
      selectedPills.appendChild(pill);
    });

    if(!activeKey || !selections.has(activeKey)){
      activeKey = keys[0];
    }

    const ad = new Date(activeKey + "T00:00:00");
    activeDateTitle.textContent = `編集: ${formatJPDateWithWday(ad)}`;
  }

  // ===== Time grid =====
  const TIMES = (() => {
    // 9:00 (540) to 19:00 (1140) inclusive, 30min step
    const arr = [];
    for(let m=540; m<=1140; m+=30) arr.push(m);
    return arr;
  })();

  function setMode(key, mode){
    if(!key || !selections.has(key)) return;
    const entry = selections.get(key);
    entry.mode = mode;
    if(mode !== "times"){
      entry.times.clear();
    }
    selections.set(key, entry);
  }

  function renderTimeGrid(){
    timeGrid.innerHTML = "";

    const disabled = (!activeKey || !selections.has(activeKey));
    const entry = disabled ? null : selections.get(activeKey);

    // set mode button styles
    const mode = entry?.mode ?? null;
    [modeAllDay, modeAM, modePM, modeTimes].forEach(b => b.classList.remove("primary"));
    if(mode === "allday") modeAllDay.classList.add("primary");
    if(mode === "am") modeAM.classList.add("primary");
    if(mode === "pm") modePM.classList.add("primary");
    if(mode === "times") modeTimes.classList.add("primary");

    // enable/disable action buttons
    [modeAllDay, modeAM, modePM, modeTimes, clearActive].forEach(btn => {
      btn.disabled = disabled;
      btn.style.opacity = disabled ? .35 : 1;
      btn.style.cursor = disabled ? "default" : "pointer";
    });

    if(disabled) return;

    const timesDisabled = (entry.mode !== "times");

    TIMES.forEach(min => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = timeLabel(min);

      if(timesDisabled){
        chip.classList.add("disabled");
      } else {
        if(entry.times.has(min)) chip.classList.add("on");
        chip.addEventListener("click", () => {
          if(entry.times.has(min)) entry.times.delete(min);
          else entry.times.add(min);
          renderAll();
        });
      }

      timeGrid.appendChild(chip);
    });
  }

  modeAllDay.addEventListener("click", () => { setMode(activeKey, "allday"); renderAll(); });
  modeAM.addEventListener("click", () => { setMode(activeKey, "am"); renderAll(); });
  modePM.addEventListener("click", () => { setMode(activeKey, "pm"); renderAll(); });
  modeTimes.addEventListener("click", () => { setMode(activeKey, "times"); renderAll(); });

  clearActive.addEventListener("click", () => {
    if(!activeKey || !selections.has(activeKey)) return;
    selections.set(activeKey, { mode:"times", times:new Set() });
    renderAll();
  });

  // ===== Output =====
  function buildOutputText(){
    const header =
`下記、候補日時でございますが、ご都合の程いかがでしょうか？

【候補日時一覧】
`;
    const footer =
`
ご都合が悪いという事であれば、調整させていただきます。`;

    const keys = sortKeys([...selections.keys()]);
    if(keys.length === 0){
      return header + "（未選択）" + footer;
    }

    const lines = [];
    for(const key of keys){
      const d = new Date(key + "T00:00:00");
      const entry = selections.get(key);

      if(entry.mode === "allday"){
        lines.push(`${formatJPDateWithWday(d)}終日`);
      } else if(entry.mode === "am"){
        lines.push(`${formatJPDateWithWday(d)}午前`);
      } else if(entry.mode === "pm"){
        lines.push(`${formatJPDateWithWday(d)}午後`);
      } else {
        const ts = [...entry.times].sort((a,b)=>a-b).map(timeLabel);
        // times未選択の場合は日付のみ（実運用上、空のまま送らないように見える化）
        if(ts.length === 0){
          lines.push(`${formatJPDateWithWday(d)}（時間未選択）`);
        } else {
          lines.push(`${formatJPDateWithWday(d)}${ts.join(", ")}`);
        }
      }
    }

    return header + lines.join("\n") + footer;
  }

  function renderOutput(){
    output.value = buildOutputText();
  }

  // ===== Copy =====
  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(output.value);
      flashCopy("コピーしました");
    } catch(e){
      // fallback
      output.focus();
      output.select();
      const ok = document.execCommand("copy");
      flashCopy(ok ? "コピーしました" : "コピーに失敗しました");
      window.getSelection()?.removeAllRanges();
    }
  });

  resetBtn.addEventListener("click", () => {
    selections.clear();
    activeKey = null;
    renderAll();
  });

  // ===== Toasts =====
  let toastTimer = null;
  function flash(msg){
    toast.textContent = msg;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.textContent = "", 1400);
  }
  let copyTimer = null;
  function flashCopy(msg){
    copyToast.textContent = msg;
    clearTimeout(copyTimer);
    copyTimer = setTimeout(()=> copyToast.textContent = "", 1400);
  }

  // ===== Render all =====
  function renderAll(){
    renderCalendar();
    renderPills();
    renderTimeGrid();
    renderOutput();
  }

  // init
  renderDow();
  renderAll();
})();
</script>
</body>
</html>
